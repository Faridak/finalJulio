<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simple Warehouse Inventory</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <!-- Three.js with proper ES modules setup -->
    <script async src="https://unpkg.com/es-module-shims@1.6.3/dist/es-module-shims.js"></script>
    <script type="importmap">
    {
      "imports": {
        "three": "https://unpkg.com/three@0.158.0/build/three.module.js",
        "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/"
      }
    }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        #warehouse-container {
            position: relative;
            width: 100%;
            height: 600px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            overflow: hidden;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
        }
        
        .control-panel {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            min-width: 200px;
        }
        
        .info-panel {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            max-width: 300px;
        }
        
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1002;
        }
        
        .view-mode-btn {
            @apply px-3 py-1 text-sm rounded-md transition-colors;
        }
        
        .view-mode-btn.active {
            @apply bg-blue-600 text-white;
        }
        
        .view-mode-btn:not(.active) {
            @apply bg-gray-200 text-gray-700 hover:bg-gray-300;
        }
    </style>
</head>
<body class="bg-gray-50" x-data="simpleWarehouse()" x-init="init()">
    <div class="max-w-full mx-auto px-4 py-8">
        <!-- Header -->
        <div class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-gray-900">Simple Warehouse Inventory</h1>
                <p class="text-gray-600 mt-2">Manage racks with 5 shelves and 10 bins each</p>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex items-center space-x-4">
                <a href="test-warehouse-api.html" target="_blank" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700">
                    <i class="fas fa-vial mr-2"></i>Test API
                </a>
                <button @click="addRack()" class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">
                    <i class="fas fa-plus mr-2"></i>Add Rack
                </button>
                <button @click="removeRack()" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700">
                    <i class="fas fa-trash mr-2"></i>Remove Rack
                </button>
            </div>
        </div>

        <!-- Three.js Container -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-8">
            <div id="warehouse-container">
                <!-- Loading Overlay -->
                <div class="loading-overlay" x-show="loading">
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin text-4xl text-gray-400 mb-4"></i>
                        <p class="text-gray-600">Loading warehouse...</p>
                    </div>
                </div>
                
                <!-- Control Panel -->
                <div class="control-panel">
                    <h4 class="font-semibold text-gray-900 mb-3">Controls</h4>
                    
                    <!-- Warehouse Structure Info -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Structure</label>
                        <div class="space-y-1 text-sm text-gray-600">
                            <div>Racks: <span x-text="racks.length" class="font-medium"></span></div>
                            <div>Shelves: <span class="font-medium">5</span> per rack</div>
                            <div>Bins: <span class="font-medium">10</span> per shelf</div>
                            <div class="text-xs text-gray-500 mt-2">
                                Total capacity: <span x-text="racks.length * 5 * 10" class="font-medium"></span> bins
                            </div>
                        </div>
                    </div>
                    
                    <!-- Reset View -->
                    <button @click="resetView()" class="w-full bg-blue-600 text-white px-3 py-2 rounded-md hover:bg-blue-700 text-sm">
                        <i class="fas fa-home mr-2"></i>Reset View
                    </button>
                </div>
                
                <!-- Info Panel -->
                <div class="info-panel" x-show="selectedBin">
                    <h4 class="font-semibold text-gray-900 mb-2">Bin Information</h4>
                    <div class="space-y-1 text-sm">
                        <div><strong>Address:</strong> <span x-text="selectedBin.address"></span></div>
                        <div><strong>Status:</strong> <span x-text="selectedBin.status"></span></div>
                        <div x-show="selectedBin.items.length > 0">
                            <strong>Items:</strong>
                            <div class="mt-1">
                                <template x-for="item in selectedBin.items" :key="item.id">
                                    <div class="flex justify-between text-xs bg-gray-100 p-1 rounded my-1">
                                        <span x-text="item.name"></span>
                                        <span x-text="item.quantity"></span>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </div>
                    <button @click="openInventoryModal()" 
                            class="w-full mt-3 bg-green-600 text-white px-3 py-2 rounded-md hover:bg-green-700 text-sm">
                        <i class="fas fa-edit mr-2"></i>Manage Inventory
                    </button>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-blue-100">
                        <i class="fas fa-cubes text-blue-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Total Bins</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="racks.length * 5 * 10"></p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-green-100">
                        <i class="fas fa-boxes text-green-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Occupied Bins</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="getOccupiedBinCount()"></p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-yellow-100">
                        <i class="fas fa-percentage text-yellow-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Utilization</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="getUtilizationPercentage() + '%'"></p>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex items-center">
                    <div class="p-3 rounded-full bg-purple-100">
                        <i class="fas fa-layer-group text-purple-600 text-xl"></i>
                    </div>
                    <div class="ml-4">
                        <p class="text-sm font-medium text-gray-600">Racks</p>
                        <p class="text-2xl font-bold text-gray-900" x-text="racks.length"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inventory Management Modal -->
    <div x-show="showInventoryModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 z-50">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-semibold text-gray-900">Manage Inventory</h3>
                        <button type="button" @click="showInventoryModal = false" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>

                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Bin Address</label>
                            <input type="text" :value="selectedBin?.address" readonly 
                                   class="w-full border border-gray-300 rounded-md px-3 py-2 bg-gray-50">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                            <select x-model="selectedBin.status" class="w-full border border-gray-300 rounded-md px-3 py-2">
                                <option value="empty">Empty</option>
                                <option value="partial">Partial</option>
                                <option value="full">Full</option>
                                <option value="blocked">Blocked</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Items</label>
                            <template x-for="(item, index) in selectedBin.items" :key="index">
                                <div class="flex space-x-2 mb-2">
                                    <input type="text" x-model="item.name" placeholder="Item name" 
                                           class="flex-1 border border-gray-300 rounded-md px-3 py-2">
                                    <input type="number" x-model="item.quantity" placeholder="Qty" min="1"
                                           class="w-20 border border-gray-300 rounded-md px-3 py-2">
                                    <button @click="removeItem(index)" class="bg-red-500 text-white px-2 rounded">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </template>
                            <button @click="addItem()" class="text-sm text-blue-600 hover:text-blue-800">
                                <i class="fas fa-plus mr-1"></i>Add Item
                            </button>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-3 mt-6">
                        <button type="button" @click="showInventoryModal = false" 
                                class="px-4 py-2 bg-gray-300 text-gray-700 rounded-md hover:bg-gray-400">
                            Cancel
                        </button>
                        <button @click="saveInventory()" 
                                class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">
                            Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function simpleWarehouse() {
            return {
                racks: [],
                scene: null,
                camera: null,
                renderer: null,
                controls: null,
                raycaster: null,
                mouse: null,
                loading: false,
                selectedBin: null,
                showInventoryModal: false,
                binMeshes: new Map(),
                
                init() {
                    console.log('Initializing simple warehouse...');
                    // Load warehouse data from API
                    this.loadWarehouseData();
                    // Initialize Three.js
                    this.initThreeJS();
                },
                
                async loadWarehouseData() {
                    this.loading = true;
                    try {
                        const response = await fetch('api/simple-warehouse-api.php?action=warehouse_structure');
                        const data = await response.json();
                        
                        if (data.success) {
                            this.racks = data.data;
                            // Render the warehouse after a short delay to ensure Three.js is ready
                            setTimeout(() => {
                                this.renderWarehouse();
                                this.loading = false;
                            }, 500);
                        } else {
                            console.error('Failed to load warehouse data:', data.message);
                            this.createDefaultRacks();
                        }
                    } catch (error) {
                        console.error('Error loading warehouse data:', error);
                        this.createDefaultRacks();
                    }
                },
                
                createDefaultRacks() {
                    this.createRacks(3);
                    this.renderWarehouse();
                    this.loading = false;
                },
                
                initThreeJS() {
                    const container = document.getElementById('warehouse-container');
                    
                    if (!container) {
                        console.error('Container not found');
                        return;
                    }
                    
                    // Scene
                    this.scene = new THREE.Scene();
                    this.scene.background = new THREE.Color(0xf0f4f8);
                    
                    // Camera
                    this.camera = new THREE.PerspectiveCamera(
                        75, 
                        container.clientWidth / container.clientHeight, 
                        0.1, 
                        1000
                    );
                    this.camera.position.set(15, 10, 15);
                    
                    // Renderer
                    this.renderer = new THREE.WebGLRenderer({ antialias: true });
                    this.renderer.setSize(container.clientWidth, container.clientHeight);
                    this.renderer.shadowMap.enabled = false; // Disable shadows to avoid proxy errors
                    container.appendChild(this.renderer.domElement);
                    
                    // Controls
                    import('three/addons/controls/OrbitControls.js').then((module) => {
                        const OrbitControls = module.OrbitControls;
                        this.controls = new OrbitControls(this.camera, this.renderer.domElement);
                        this.controls.enableDamping = true;
                        this.controls.dampingFactor = 0.1;
                    });
                    
                    // Lighting
                    this.setupLighting();
                    
                    // Raycaster for clicking
                    this.setupRaycaster();
                    
                    // Handle window resize
                    window.addEventListener('resize', () => this.onWindowResize());
                    
                    // Start animation loop
                    this.animate();
                },
                
                setupLighting() {
                    // Ambient light
                    const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
                    this.scene.add(ambientLight);
                    
                    // Directional light (main)
                    const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
                    directionalLight.position.set(10, 20, 10);
                    this.scene.add(directionalLight);
                },
                
                setupRaycaster() {
                    this.raycaster = new THREE.Raycaster();
                    this.mouse = new THREE.Vector2();
                    
                    this.renderer.domElement.addEventListener('click', (event) => {
                        const rect = this.renderer.domElement.getBoundingClientRect();
                        this.mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
                        this.mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;
                        
                        this.raycaster.setFromCamera(this.mouse, this.camera);
                        
                        // Check intersection with bins
                        const intersectObjects = Array.from(this.binMeshes.values());
                        const intersects = this.raycaster.intersectObjects(intersectObjects);
                        
                        if (intersects.length > 0) {
                            const clickedMesh = intersects[0].object;
                            const binData = clickedMesh.userData;
                            this.selectBin(binData);
                        }
                    });
                },
                
                createRacks(count) {
                    this.racks = [];
                    for (let i = 0; i < count; i++) {
                        this.racks.push(this.createRackData(i));
                    }
                },
                
                createRackData(index) {
                    const rack = {
                        id: index,
                        address: `R${index + 1}`,
                        shelves: []
                    };
                    
                    // Create 5 shelves
                    for (let shelfIndex = 0; shelfIndex < 5; shelfIndex++) {
                        const shelf = {
                            id: shelfIndex,
                            bins: []
                        };
                        
                        // Create 10 bins per shelf
                        for (let binIndex = 0; binIndex < 10; binIndex++) {
                            shelf.bins.push({
                                id: `${index}-${shelfIndex}-${binIndex}`,
                                address: `R${index + 1}-S${shelfIndex + 1}-B${binIndex + 1}`,
                                status: 'empty',
                                items: []
                            });
                        }
                        
                        rack.shelves.push(shelf);
                    }
                    
                    return rack;
                },
                
                renderWarehouse() {
                    // Clear existing scene objects
                    while(this.scene.children.length > 0) { 
                        this.scene.remove(this.scene.children[0]); 
                    }
                    
                    // Re-add lighting
                    this.setupLighting();
                    
                    // Create floor
                    const floorGeometry = new THREE.PlaneGeometry(50, 50);
                    const floorMaterial = new THREE.MeshLambertMaterial({ 
                        color: 0xf0f0f0,
                        transparent: true,
                        opacity: 0.5
                    });
                    const floor = new THREE.Mesh(floorGeometry, floorMaterial);
                    floor.rotation.x = -Math.PI / 2;
                    floor.position.y = -1;
                    this.scene.add(floor);
                    
                    // Create racks
                    this.binMeshes.clear();
                    this.racks.forEach((rack, rackIndex) => {
                        const rackGroup = new THREE.Group();
                        
                        // Position racks
                        const rackX = (rackIndex - (this.racks.length - 1) / 2) * 8;
                        rackGroup.position.set(rackX, 0, 0);
                        
                        // Create rack structure
                        this.createRackStructure(rackGroup);
                        
                        // Create shelves and bins
                        rack.shelves.forEach((shelf, shelfIndex) => {
                            const shelfY = (shelfIndex + 1) * 1.5;
                            
                            // Create shelf platform
                            const shelfGeometry = new THREE.BoxGeometry(6, 0.1, 1.5);
                            const shelfMaterial = new THREE.MeshLambertMaterial({ color: 0x8B7355 });
                            const shelfMesh = new THREE.Mesh(shelfGeometry, shelfMaterial);
                            shelfMesh.position.set(0, shelfY, 0);
                            rackGroup.add(shelfMesh);
                            
                            // Create bins
                            shelf.bins.forEach((bin, binIndex) => {
                                const binX = -2.7 + binIndex * 0.6;
                                
                                // Create bin
                                const binGeometry = new THREE.BoxGeometry(0.5, 0.8, 1.2);
                                const binMaterial = new THREE.MeshLambertMaterial({ 
                                    color: this.getBinColor(bin.status),
                                    transparent: true,
                                    opacity: 0.8
                                });
                                
                                const binMesh = new THREE.Mesh(binGeometry, binMaterial);
                                binMesh.position.set(binX, shelfY + 0.4, 0);
                                binMesh.userData = bin;
                                rackGroup.add(binMesh);
                                
                                // Store reference for interaction
                                this.binMeshes.set(bin.id, binMesh);
                            });
                        });
                        
                        this.scene.add(rackGroup);
                    });
                },
                
                createRackStructure(rackGroup) {
                    // Create rack frame
                    const rackMaterial = new THREE.MeshLambertMaterial({ color: 0x2563EB });
                    
                    // Main rack body
                    const mainBodyGeometry = new THREE.BoxGeometry(6, 0.1, 1.5);
                    const mainBody = new THREE.Mesh(mainBodyGeometry, rackMaterial);
                    mainBody.position.set(0, 0.05, 0);
                    rackGroup.add(mainBody);
                    
                    // Vertical posts
                    const postGeometry = new THREE.BoxGeometry(0.1, 8, 0.1);
                    const postMaterial = new THREE.MeshLambertMaterial({ color: 0x1E40AF });
                    
                    const positions = [
                        [-2.95, 4, -0.7],
                        [2.95, 4, -0.7],
                        [-2.95, 4, 0.7],
                        [2.95, 4, 0.7]
                    ];
                    
                    positions.forEach(pos => {
                        const post = new THREE.Mesh(postGeometry, postMaterial);
                        post.position.set(...pos);
                        rackGroup.add(post);
                    });
                },
                
                getBinColor(status) {
                    const colors = {
                        'empty': 0xE5E7EB,     // Gray
                        'partial': 0xFEF3C7,   // Yellow
                        'full': 0xDCFCE7,      // Green
                        'blocked': 0xFEE2E2    // Red
                    };
                    return colors[status] || 0xE5E7EB;
                },
                
                selectBin(binData) {
                    this.selectedBin = binData;
                    console.log('Selected bin:', binData);
                },
                
                openInventoryModal() {
                    this.showInventoryModal = true;
                },
                
                addItem() {
                    if (!this.selectedBin) return;
                    
                    this.selectedBin.items.push({
                        id: Date.now(),
                        name: '',
                        quantity: 1,
                        date_arrived: new Date().toISOString().split('T')[0]
                    });
                },
                
                removeItem(index) {
                    if (!this.selectedBin) return;
                    
                    this.selectedBin.items.splice(index, 1);
                },
                
                async saveInventory() {
                    if (!this.selectedBin) return;
                    
                    // Update bin status based on items
                    if (this.selectedBin.items.length === 0) {
                        this.selectedBin.status = 'empty';
                    } else if (this.selectedBin.items.length < 3) {
                        this.selectedBin.status = 'partial';
                    } else {
                        this.selectedBin.status = 'full';
                    }
                    
                    // Update bin mesh color
                    const binMesh = this.binMeshes.get(this.selectedBin.id);
                    if (binMesh) {
                        binMesh.material.color.set(this.getBinColor(this.selectedBin.status));
                    }
                    
                    // Save to backend
                    try {
                        const response = await fetch('api/simple-warehouse-api.php', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                action: 'update_bin_inventory',
                                bin_id: this.selectedBin.id,
                                status: this.selectedBin.status,
                                items: this.selectedBin.items
                            })
                        });
                        
                        const result = await response.json();
                        if (!result.success) {
                            console.error('Failed to save inventory:', result.message);
                        }
                    } catch (error) {
                        console.error('Error saving inventory:', error);
                    }
                    
                    this.showInventoryModal = false;
                    console.log('Inventory saved:', this.selectedBin);
                },
                
                async addRack() {
                    try {
                        const response = await fetch('api/simple-warehouse-api.php', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                action: 'add_rack'
                            })
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            // Reload warehouse data
                            this.loadWarehouseData();
                        } else {
                            console.error('Failed to add rack:', result.message);
                        }
                    } catch (error) {
                        console.error('Error adding rack:', error);
                    }
                },
                
                async removeRack() {
                    if (this.racks.length <= 1) {
                        alert('Cannot remove the last rack');
                        return;
                    }
                    
                    try {
                        const response = await fetch('api/simple-warehouse-api.php', {
                            method: 'DELETE',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                rack_id: this.racks[this.racks.length - 1].id
                            })
                        });
                        
                        const result = await response.json();
                        if (result.success) {
                            // Reload warehouse data
                            this.loadWarehouseData();
                        } else {
                            console.error('Failed to remove rack:', result.message);
                        }
                    } catch (error) {
                        console.error('Error removing rack:', error);
                    }
                },
                
                getOccupiedBinCount() {
                    let count = 0;
                    this.racks.forEach(rack => {
                        rack.shelves.forEach(shelf => {
                            shelf.bins.forEach(bin => {
                                if (bin.status !== 'empty') {
                                    count++;
                                }
                            });
                        });
                    });
                    return count;
                },
                
                getUtilizationPercentage() {
                    const totalBins = this.racks.length * 5 * 10;
                    const occupiedBins = this.getOccupiedBinCount();
                    return totalBins > 0 ? Math.round((occupiedBins / totalBins) * 100) : 0;
                },
                
                resetView() {
                    this.camera.position.set(15, 10, 15);
                    if (this.controls) {
                        this.controls.target.set(0, 0, 0);
                        this.controls.update();
                    }
                },
                
                animate() {
                    requestAnimationFrame(() => this.animate());
                    
                    if (this.controls) {
                        this.controls.update();
                    }
                    
                    if (this.renderer && this.scene && this.camera) {
                        this.renderer.render(this.scene, this.camera);
                    }
                },
                
                onWindowResize() {
                    const container = document.getElementById('warehouse-container');
                    
                    this.camera.aspect = container.clientWidth / container.clientHeight;
                    this.camera.updateProjectionMatrix();
                    
                    this.renderer.setSize(container.clientWidth, container.clientHeight);
                }
            };
        }
    </script>
    
    <!-- Three.js ES Module initialization -->
    <script type="module">
        import * as THREE from 'three';
        
        // Make THREE available globally
        window.THREE = THREE;
        
        console.log('Three.js ES modules loaded');
    </script>
</body>
</html>